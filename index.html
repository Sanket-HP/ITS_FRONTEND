<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intent-to-System AI | Architecting Tomorrow</title>
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    
    <style>
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
            padding-bottom: 5rem;
        }

        header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .logo-group { display: flex; align-items: center; gap: 0.75rem; }
        .logo { font-weight: 800; font-size: 1.25rem; color: var(--primary); letter-spacing: -0.025em; }
        .version { font-size: 0.7rem; background: #eff6ff; padding: 0.2rem 0.5rem; border-radius: 4px; color: var(--primary); font-weight: 700; }

        .action-bar { display: flex; gap: 0.75rem; }

        main { max-width: 1000px; margin: 2rem auto; padding: 0 1.5rem; }

        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid transparent;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-outline { background: white; border-color: var(--border); color: var(--text-main); }
        .btn-outline:hover { background: var(--bg-color); border-color: var(--text-muted); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .stepper { display: flex; justify-content: space-between; margin: 2rem 0 3rem; position: relative; }
        .stepper::before { content: ''; position: absolute; top: 18px; left: 0; right: 0; height: 2px; background: var(--border); z-index: 1; }
        .step { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; width: 20%; }
        .step-circle { width: 36px; height: 36px; background: white; border: 2px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 700; margin-bottom: 0.5rem; transition: 0.3s; }
        .step.active .step-circle { border-color: var(--primary); color: var(--primary); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        .step.completed .step-circle { background: var(--primary); border-color: var(--primary); color: white; }
        .step-label { font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }

        .card { background: var(--card-bg); border-radius: 1rem; padding: 2rem; box-shadow: var(--shadow); margin-bottom: 2rem; border: 1px solid var(--border); animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .input-card textarea { width: 100%; height: 100px; padding: 1rem; border: 1px solid var(--border); border-radius: 0.75rem; font-family: inherit; font-size: 1rem; margin: 1rem 0; resize: none; transition: 0.2s; }
        .input-card textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }

        .viz-container { background: #fcfcfc; border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin: 1.5rem 0; display: flex; justify-content: center; min-height: 200px; overflow-x: auto; }

        .badge { padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        .badge-low { background: #dcfce7; color: #166534; }
        .badge-medium { background: #fef3c7; color: #92400e; }
        .badge-high { background: #fee2e2; color: #991b1b; }

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        th { text-align: left; padding: 0.75rem; border-bottom: 2px solid var(--border); color: var(--text-muted); }
        td { padding: 0.75rem; border-bottom: 1px solid var(--border); }

        .decision-card { background: var(--bg-color); padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 0.5rem; border-left: 4px solid var(--primary); }
        .decision-header { display: flex; justify-content: space-between; align-items: center; }

        .raw-json { background: #1e293b; color: #cbd5e1; padding: 1rem; border-radius: 0.5rem; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; overflow-x: auto; margin-top: 1rem; display: none; }
        
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 0.8s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading .spinner { display: inline-block; }
        .loading .btn-text { display: none; }

        .error-toast { background: #fef2f2; border: 1px solid #fee2e2; color: var(--error); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1.5rem; display: none; font-weight: 500; }
    </style>
</head>
<body>

<header>
    <div class="logo-group">
        <div class="logo">Intent-to-System AI</div>
        <div class="version">v2.5.0-Visual</div>
    </div>
    <div class="action-bar">
        <button id="exportJsonBtn" class="btn btn-outline" disabled>
            <span>Export JSON</span>
        </button>
    </div>
</header>

<main id="capture-area">
    <div id="errorToast" class="error-toast"></div>

    <section class="card input-card">
        <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem;">System Architecture Intent</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem;">Describe the core functionality, constraints, and operational environment.</p>
        <textarea id="intentInput" placeholder="e.g., Design a high-availability inventory management system for a global e-commerce platform with 10ms latency requirements..."></textarea>
        <button id="generateBtn" class="btn btn-primary">
            <span class="spinner"></span>
            <span class="btn-text">Generate System</span>
        </button>
    </section>

    <!-- Stepper Navigation -->
    <div class="stepper" id="stepper">
        <div class="step" data-step="1"><div class="step-circle">1</div><div class="step-label">Analyze</div></div>
        <div class="step" data-step="2"><div class="step-circle">2</div><div class="step-label">Design</div></div>
        <div class="step" data-step="3"><div class="step-circle">3</div><div class="step-label">Simulate</div></div>
        <div class="step" data-step="4"><div class="step-circle">4</div><div class="step-label">Optimize</div></div>
        <div class="step" data-step="5"><div class="step-circle">5</div><div class="step-label">Explain</div></div>
    </div>

    <div id="outputContainer"></div>
</main>

<script>
    // Initialize Mermaid
    mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });

    // Note: Localhost API endpoints might not resolve in this environment.
    const API_BASE = "http://127.0.0.1:8000";
    const generateBtn = document.getElementById('generateBtn');
    const intentInput = document.getElementById('intentInput');
    const outputContainer = document.getElementById('outputContainer');
    const errorToast = document.getElementById('errorToast');
    const exportJsonBtn = document.getElementById('exportJsonBtn');

    let pipelineResults = {
        intent: "",
        steps: {}
    };

    async function runPipeline() {
        const intent = intentInput.value.trim();
        if (!intent) return showToast("Please enter a system intent.");

        resetUI();
        setLoading(true);
        pipelineResults.intent = intent;

        try {
            // STEP 1: Analysis
            updateStepper(1);
            const analysis = await callApi('/api/analyze-intent', { content: intent });
            pipelineResults.steps[1] = analysis;
            renderSection(1, "Intent Analysis", analysis);

            // STEP 2: Architecture
            updateStepper(2);
            const architecture = await callApi('/api/generate-system', analysis);
            pipelineResults.steps[2] = architecture;
            renderSection(2, "Initial Architecture", architecture);

            // STEP 3: Simulation
            updateStepper(3);
            const simulation = await callApi('/api/simulate-failure', architecture);
            pipelineResults.steps[3] = simulation;
            renderSection(3, "Failure Simulation", simulation);

            // STEP 4: Optimization
            updateStepper(4);
            const optimization = await callApi('/api/optimize-system', {
                objective: "resilience",
                system_architecture: architecture
            });
            pipelineResults.steps[4] = optimization;
            renderSection(4, "Optimized Architecture", optimization);

            // STEP 5: Explanation
            updateStepper(5);
            const finalArch = optimization.optimized_architecture;
            const explanationRequest = {
                modules: finalArch.modules,
                data_flow: finalArch.data_flow,
                decision_rules: finalArch.decision_rules
            };
            const explanation = await callApi('/api/explain-system', explanationRequest);
            pipelineResults.steps[5] = explanation;
            renderSection(5, "Executive Explanation", explanation);

            completeStepper();
            enableExports(true);
        } catch (err) {
            showToast(`Execution Error: ${err.message}. Ensure your backend server is running.`);
            console.error(err);
        } finally {
            setLoading(false);
        }
    }

    async function callApi(endpoint, body) {
        let backoff = 1000;
        for (let i = 0; i < 5; i++) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Server Error ${response.status}`);
                }
                return await response.json();
            } catch (e) {
                if (i === 4) throw e;
                await new Promise(r => setTimeout(r, backoff));
                backoff *= 2;
            }
        }
    }

    function renderSection(stepId, title, data) {
        const card = document.createElement('div');
        card.className = 'card';
        card.id = `step-card-${stepId}`;

        let bodyHtml = '';
        const rawId = `raw-${stepId}`;

        switch(stepId) {
            case 1:
                bodyHtml = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div><strong>Scope:</strong> ${data.scope || 'General System'}</div>
                        <div><strong>Entities:</strong> ${(data.entities || []).join(', ')}</div>
                    </div>
                    <ul style="margin-top:1rem; padding-left:1.25rem;">
                         ${(data.insights || []).map(i => `<li>${i}</li>`).join('')}
                    </ul>
                `;
                break;
            case 2:
            case 4:
                const arch = stepId === 4 ? data.optimized_architecture : data;
                bodyHtml = `
                    <div class="viz-container">
                        <div class="mermaid" id="mermaid-${stepId}">
                            ${generateMermaidGraph(arch)}
                        </div>
                    </div>
                    <table>
                        <thead><tr><th>Module</th><th>Responsibility</th><th>Connectivity</th></tr></thead>
                        <tbody>
                            ${(arch.modules || []).map(m => `
                                <tr>
                                    <td><strong>${m.name}</strong></td>
                                    <td>${m.responsibility}</td>
                                    <td>
                                        <div style="font-size:0.75rem">IN: ${(m.inputs || []).join(', ')}</div>
                                        <div style="font-size:0.75rem">OUT: ${(m.outputs || []).join(', ')}</div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                break;
            case 3:
                bodyHtml = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        ${(data.failure_points || []).map(v => `
                            <div style="padding:1rem; background:var(--bg-color); border-radius:0.5rem; border:1px solid var(--border);">
                                <span class="badge badge-${(v.risk_level || 'low').toLowerCase()}">${v.risk_level || 'LOW'}</span>
                                <div style="font-weight:700; margin-top:0.5rem">${v.point}</div>
                                <div style="font-size:0.8rem; color:var(--text-muted)">${v.impact}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                break;
            case 5:
                bodyHtml = `
                    <div>
                        ${(data.explanations || []).map((exp, idx) => `
                            <div class="decision-card">
                                <div class="decision-header">
                                    <span style="font-size:0.75rem;font-weight:700;color:var(--primary)">
                                        DECISION ${idx + 1}
                                    </span>
                                    <span class="badge badge-${(exp.risk_level || 'LOW').toLowerCase()}">
                                        ${exp.risk_level || 'LOW'} RISK
                                    </span>
                                </div>
                                <p style="font-weight:600">${exp.decision || 'N/A'}</p>
                                <p style="font-size:0.85rem;color:var(--text-muted)">${exp.justification || ''}</p>
                                <div style="display:flex;align-items:center;gap:0.5rem;margin-top:0.5rem;">
                                    <div style="flex:1;height:4px;background:#e2e8f0;border-radius:2px;">
                                        <div style="width:${exp.confidence || 0}%;height:100%;background:var(--success);border-radius:2px;"></div>
                                    </div>
                                    <span style="font-size:0.7rem;font-weight:700">${exp.confidence || 0}% CONFIDENCE</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                break;
        }

        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="font-size:1.1rem; color:var(--text-main)">${title}</h3>
                <button class="btn btn-outline" style="padding:0.2rem 0.6rem; font-size:0.7rem;" onclick="toggleRaw('${rawId}')">Raw JSON</button>
            </div>
            <div class="step-content">${bodyHtml}</div>
            <pre id="${rawId}" class="raw-json">${JSON.stringify(data, null, 2)}</pre>
        `;

        outputContainer.appendChild(card);
        
        if (stepId === 2 || stepId === 4) {
            setTimeout(() => {
                mermaid.init(undefined, document.getElementById(`mermaid-${stepId}`));
            }, 50);
        }
        
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function generateMermaidGraph(architecture) {
        if (!architecture || !architecture.modules) return "graph LR; No[Data Found]";
        
        if (!Array.isArray(architecture.data_flow)) {
            architecture.data_flow = [];
        }

        let graph = "graph LR\n";
        graph += "  classDef module fill:#fff,stroke:#2563eb,stroke-width:2px,color:#1e293b,rx:5,ry:5;\n";
        
        const modules = architecture.modules;
        modules.forEach(m => {
            const safeId = m.name.replace(/[^a-zA-Z0-9]/g, '_');
            graph += `  ${safeId}("${m.name}")\n`;
            graph += `  class ${safeId} module\n`;
        });

        if (architecture.data_flow.length > 0) {
            architecture.data_flow.forEach(flow => {
                if (typeof flow === 'string') {
                    graph += `  ${flow.replace(/ /g, '')}\n`;
                } else if (Array.isArray(flow.steps)) {
                    flow.steps.forEach(step => {
                        if (typeof step === "string" && step.includes("->")) {
                            const [from, to] = step.split("->").map(s => s.trim());
                            const fromId = from.replace(/[^a-zA-Z0-9]/g, '_');
                            const toId = to.replace(/[^a-zA-Z0-9]/g, '_');
                            const edgeLabel = flow.flow_name ? ` -- "${flow.flow_name}" --> ` : " --> ";
                            if (fromId && toId) {
                                graph += `  ${fromId}${edgeLabel}${toId}\n`;
                            }
                        }
                    });
                }
            });
        } else {
            modules.forEach(m => {
                const safeId = m.name.replace(/[^a-zA-Z0-9]/g, '_');
                (m.outputs || []).forEach(out => {
                    const target = modules.find(mod => (mod.inputs || []).includes(out));
                    if (target) {
                        const targetId = target.name.replace(/[^a-zA-Z0-9]/g, '_');
                        graph += `  ${safeId} -- "${out}" --> ${targetId}\n`;
                    }
                });
            });
        }
        return graph;
    }

    function downloadJson() {
        const blob = new Blob([JSON.stringify(pipelineResults, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Intent-to-System_Data_${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function updateStepper(stepId) {
        document.querySelectorAll('.step').forEach(s => {
            const sid = parseInt(s.dataset.step);
            s.classList.remove('active');
            if (sid < stepId) s.classList.add('completed');
            if (sid === stepId) s.classList.add('active');
        });
    }

    function completeStepper() {
        document.querySelectorAll('.step').forEach(s => {
            s.classList.remove('active');
            s.classList.add('completed');
        });
    }

    function setLoading(isLoading) {
        generateBtn.disabled = isLoading;
        intentInput.disabled = isLoading;
        generateBtn.classList.toggle('loading', isLoading);
        if (isLoading) errorToast.style.display = 'none';
    }

    function showToast(msg) {
        errorToast.textContent = msg;
        errorToast.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetUI() {
        outputContainer.innerHTML = '';
        pipelineResults.steps = {};
        enableExports(false);
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active', 'completed'));
    }

    function enableExports(enabled) {
        exportJsonBtn.disabled = !enabled;
    }

    function toggleRaw(id) {
        const el = document.getElementById(id);
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    generateBtn.addEventListener('click', runPipeline);
    exportJsonBtn.addEventListener('click', downloadJson);
</script>

</body>
</html>